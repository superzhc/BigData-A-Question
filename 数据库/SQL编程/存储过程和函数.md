<!--
 * @Github       : https://github.com/superzhc/BigData-A-Question
 * @Author       : SUPERZHC
 * @CreateDate   : 2020-12-16 14:56:48
 * @LastEditTime : 2020-12-17 16:27:20
 * @Copyright 2020 SUPERZHC
-->
# 存储过程和函数

创建存储过程和函数是指将经常使用的一组 SQL 语句组合在一起，并将这些 SQL 语句当作一个整体存储在 MySQL 服务器中。存储程序可以分为存储过程和函数，MySQL 中创建存储过程和函数使用的语句分别是：`CREATE PROCEDURE` 和 `CREATE FUNCTION`。使用 CALL 语句来调用存储过程，只能用输出变量返回值。函数可以从语句外调用（通过引用函数名），也能返回标量值。存储过程也可以调用其他存储过程。

## 创建存储过程

在 MySQL 中创建存储过程通过 SQL 语句 `CREATE PROCEDURE` 来实现，其语法形式如下：

```sql
CREATE PROCEDURE procedure_name([proc_param[,...]])[characteristic...] routine_body
```

在上述语句中，参数 procedure_name 表示所要创建的存储过程的名字，参数 proc_param 表示存储过程的参数，参数 characteristic 表示存储过程的特性，参数 routine_body 表示存储过程的 SQL 语句代码，可以用 `BEGIN…END` 来标志 SQL 语句的开始和结束。

> 在具体创建存储过程时，存储过程名不能与已经存在的存储过程名重名。

**proc_param**

proc_param 中每个参数的语法形式如下：

```sql
[IN|OUT|INOUT] param_name type
```

在上述语句中，每个参数由 3 部分组成，分别为输入/输出类型、参数名和参数类型。

- 输入/输出类型有3种：
  - IN 表示输入类型；
  - OUT 表示输出类型；
  - INOUT 表示输入/输出类型。
- param_name 表示参数名。
- type 表示参数类型，可以是 MySQL 所支持的任意一个数据类型。

**charateristic**

参数 charateristic 指定存储过程的特性，有以下取值：

- LANGUAGE SQL：说明 routine_body 部分是由 SQL 语句组成的，当前系统支持的语言为 SQL，SQL 是 LANGUAGE 特性的唯一值。
- `[NOT] DETERMINISTIC`：指明存储过程执行的结果是否正确。如果没有指定任意一个值，就默认为 `NOT DETERMINISTIC`。
  - DETERMINISTIC 表示结果是确定的。每次执行存储过程时，相同的输入会得到相同的输出。
  - NOT DETERMINISTIC表示结果是不确定的，相同的输入可能得到不同的输出。
- `{CONTAINS SQL | NOSQL | READS SQL DATA | MODIFIES SQL DATA}`：指明子程序使用 SQL 语句的限制。默认情况下，系统会指定为 `CONTAINS SQL`。
  - `CONTAINS SQL` 表名子程序包含 SQL 语句，但是不包含读写数据的语句；
  - `NO SQL` 表明子程序不包含 SQL 语句；
  - `READS SQL DATA` 说明子程序包含读数据的语句；
  - `MODIFIES SQL DATA` 表明子程序包含写数据的语句。
- `SQL SECURITY{DEFINER | INVOKER}`：指明谁有权限来执行。默认情况下，系统指定为 `DEFINER`。
  - DEFINER 表示只有定义者才能执行。
  - INVOKER 表示拥有权限的调用者可以执行。
- `COMMENT 'string'`：注释信息，可以用来描述存储过程或函数。

> MySQL 中默认的语句结束符为分号（`;`）。存储过程中的 SQL 语句需要分号来结束。为了避免冲突，首先用 `DELIMITER $$` 将 MySQL 的结束符设置为 `$$`，然后用 `DELIMITER ;` 来将结束符恢复成分号。

## 创建函数

在MySQL中，创建函数通过 SQL 语句 `CREATE FUNCTION` 来实现，其语法形式如下：

```sql
CREATE FUNCTION func_name([func_param[,...]]) [characteristic...] routine_body
```

在上述语句中，参数 func_name 表示所要创建的函数的名字；参数 func_param 表示函数的参数；参数 characteristic 表示函数的特性，该参数的取值与存储过程中的取值相同；参数 routine_body 表示函数的 SQL 语句代码，可以用 `BEGIN…END` 来表示 SQL 语句的开始和结束。

> 在具体创建函数时，函数名不能与已经存在的函数名重名

**func_param**

func_param 中的每个参数的语法形式如下：

```sql
param_name type
```

在上述语句中，每个参数由两部分组成，分别为参数名和参数类型。

- param_name 表示参数名；
- type 表示参数类型，可以是 MySQL 所支持的任意一种数据类型。

## 变量的使用

在存储过程和函数中，可以定义和使用变量。用户可以使用关键字 DECLARE 来定义变量，然后可以为变量赋值。这些变量的作用范围是 `BEGIN…END` 程序段中。

**定义变量**

MySQL 中可以使用 DECLARE 关键字来定义变量。定义变量的基本语法如下：

```sql
DECLARE var_name[,...] type [DEFAULT value]
```

其中，关键字 DECLARE 是用来声明变量的；参数 var_name 是变量的名称，这里可以同时定义多个变量；参数 type 用来指定变量的类型；`DEFAULT value` 子句将变量默认值设置为 value，没有使用 DEFAULT 子句时，默认值为 NULL。

**为变量赋值**

MySQL 中可以使用关键字 SET 来为变量赋值，SET 语句的基本语法如下：

```sql
SET var_name=expr[,var_name=expr...]
```

其中，关键字 SET 用来为变量赋值；参数 var_name 是变量的名称；参数 expr 是赋值表达式。一个 SET 语句可以同时为多个变量赋值，各个变量的赋值语句之间用逗号隔开。

MySQL 中还可以使用 `SELECT…INTO` 语句为变量赋值。其基本语法如下：

```sql
SELECT col_name[,...] INTO var_name[,...]
    FROM table_name WHERE condition
```

其中，参数 col_name 表示查询的字段名称；参数 var_name 是变量的名称；参数 table_name 指表的名称；参数 condition 指查询条件。

## 定义条件和处理程序

定义条件和处理程序是事先定义程序执行过程中可能遇到的问题，并且可以在处理程序中定义解决这些问题的办法。这种方式可以提前预测可能出现的问题，并提出解决办法。这样可以增强程序处理问题的能力，避免程序异常停止。MySQL 中都是通过关键字 DECLARE 来定义条件和处理程序的。

### 定义条件

MySQL 中可以使用 DECLARE 关键字来定义条件，其基本语法如下：

```sql
DECLARE condition_name CONDITION FOR condition_value
-- condition_value:
-- SQLSTATE[VALUE] sqlstate_value|mysql_error_code
```

其中，参数 condition_name 表示条件的名称；参数 condition_value 表示条件的类型；参数 sqlstate_value 和参数 mysql_error_code 都可以表示 MySQL 的错误。

**示例**

```sql
-- 方法一：使用 sqlstate_value
DECLARE can_not_find CONDITION FOR SQLSTATE '42S02';
-- 方法二：使用 mysql_error_code
DECLARE can_not_find CONDITION FOR 1146;
```

### 定义处理程序

MySQL 中可以使用 DECLARE 关键字来定义处理程序，其基本语法如下：

```sql
DECLARE handler_type HANDLER FOR condition_value[,...] proc_statement
-- handler_type:
-- CONTINUE|EXIT|UNDO 
-- condition_value:
-- SQLSTATE[VALUE] sqlstate_value|condition_name|SQLWARNING|NOT FOUND|SQLEXCEPTION|mysql_error_code
```

- handler_type 指明错误的处理方式，该参数有3个取值，分别是 CONTINUE、EXIT 和 UNDO。
  - CONTINUE 表示遇到错误不进行处理，继续向下执行；
  - EXIT 表示遇到错误后马上退出；
  - UNDO 表示遇到错误后撤回之前的操作，MySQL 中暂时还不支持这种处理方式。
- condition_value 表示错误类型，可以有以下取值。
  - `SQLSTATE[VALUE] sqlstate_value`：包含5个字符的字符串错误值；
  - continue_name：表示 DECLARE CONDITION 定义的错误条件名称。
  - SQLWARNING：匹配所有以 01 开头的 SQLSTATE 错误代码。
  - NOT FOUND：匹配所有以 02 开头的 SQLSTATE 错误代码。
  - SQLEXCEPTION：匹配所有没有被 SQLWARNING 或 NOT FOUND 捕获的 SQLSTATE 错误代码。
  - mysql_error_code：匹配数值类型错误代码。
- proc_statement 为程序语句段，表示在遇到定义的错误时需要执行的存储过程或函数。

**示例**

```sql
-- 捕获 sqlstate_value
DECLARE CONTINUE HANDLER FOR SQLSTATE '42S02' SET @info='NOT FOUND';
-- 使用 mysql_error_code
DECLARE CONTINUE HANDLER FOR 1146 SET @info='NOT FOUND';
-- 先定义条件，然后调用
DECLARE not_found CONDITION FOR 1146;
DECLARE CONTINUE HANDLER FOR not_found SET @info='NOT FOUND';
-- 使用 SQLWARNING
DECLARE EXIT HANDLER FOR SQLWARNING SET @info='ERROR';
-- 使用 NOT FOUND
DECLARE EXIT HANDLER FOR NOT FOUND SET @info='NOT FOUND';
-- 使用 SQLEXCEPTION
DECLARE EXIT HANDLER FOR SQLEXCEPTION SET @info='ERROR';
```

## 游标的使用

查询语句可能查询出多条记录，在存储过程和函数中使用游标来逐条读取查询结果集中的记录。游标的使用包括声明游标、打开游标、使用游标和关闭游标。游标必须声明在处理程序之前，并且声明在变量和条件之后。

**声明游标**

MySQL 中可以使用 DECLARE 关键字来声明游标，其基本语法如下：

```sql
DECLARE cursor_name CURSOR FOR select_statement;
```

其中，参数 cursor_name 表示游标的名称；参数 select_statement 表示 SELECT 语句的内容。

**打开游标**

MySQL 中使用关键字 OPEN 来打开游标，其基本语法如下：

```sql
OPEN cursor_name;
```

其中，参数 cursor_name 表示游标的名称。

**使用游标**

MySQL 中使用关键字 FETCH 来使用游标，其基本语法如下：

```sql
FETCH cursor_name INTO var_name[,var_name...];
```

其中，参数 cursor_name 表示游标的名称；参数 var_name 表示将游标中的 SELECT 语句查询出来的信息存入该参数中。var_name 必须在声明游标之前就定义好。

**关闭游标**

MySQL 中使用关键字 CLOSE 来关闭游标，其基本语法如下：

```sql
CLOSE cursor_name;
```

其中，参数 cursor_name 表示游标的名称。

> 如果存储过程或函数中执行了 SELECT 语句，并且 SELECT 语句会查询出多条记录，这种情况最好使用游标来逐条读取记录，游标必须在处理程序之前且在变量和条件之后声明，而且游标使用完后一定要关闭。

## 流程控制的使用

存储过程和函数中可以使用流程控制来控制语句的执行。MySQL 中可以使用 IF 语句、CASE 语句、LOOP 语句、LEAVE 语句、ITERATE 语句、REPEAT 语句和 WHILE 语句来进行流程控制。

### IF 语句

IF 语句用来进行条件判断，根据条件执行不同的语句。其语法的基本形式如下：

```sql
IF search_condition THEN statement_list
    [ELSEIF search_condition THEN statement_list] ...
    [ELSE statement_list] 
END IF
```

参数 search_condition 表示条件判断语句；参数 statement_list 表示不同条件的执行语句。

**示例**

```sql
IF age>20 THEN SET @count1=@count1+1;
    ELSEIF age=20 THEN @count2=@count2+1;
    ELSE @count3=@count3+1;
END IF;
```

### CASE 语句

CASE 语句可实现比 IF 语句更复杂的条件判断，其语法的基本形式如下：

```sql
CASE case_value
    WHEN when_value THEN statement_list
    [WHEN when_value THEN statement_list ...]
    ELSE statement_list
END CASE 
```

其中，参数 case_value 表示条件判断的变量；参数 when_value 表示变量的取值；参数 statement_list 表示不同 when_value 值的执行语句。

CASE 语句还有另一种形式，该形式的语法如下：

```sql
CASE
    WHEN search_condition THEN statement_list
    WHEN search_condition THEN statement_list ...
    ELSE statement_list 
END CASE
```

参数 search_condition 表示条件判断语句；参数 statement_list 表示不同条件的执行语句。

**示例**

```sql
CASE age
    WHEN 20 THEN SET @count1=@count1+1;
    ELSE SET @count2=@count2+1;
END CASE;
```

### LOOP 语句

LOOP 语句可以使某些特定的语句重复执行，实现一个简单的循环。但是 LOOP 语句本身没有停止循环，必须遇到 LEAVE 语句等才能停止循环。LOOP 语句的语法形式如下：

```sql
[begin_label:]LOOP
    statement_list
END LOOP [end_label]
```

其中，参数 begin_label 和参数 end_label 分别表示循环开始和结束的标志，这两个标志必须相同，而且都可以省略；参数 statement_list 表示需要循环执行的语句。

**示例**

```sql
add_num:LOOP
    SET @count1=@count1+1;
END LOOP add_num;
```

### LEAVE 语句

LEAVE 语句主要用于跳出循环控制，其语法形式如下：

```sql
LEAVE label
```

其中，参数 label 表示循环的标志。

**示例**

```sql
add_num:LOOP
    SET @count1=@count1+1;
    IF @count1=100 THEN
        LEAVE add_num;
END LOOP add_num;
```

### ITERATE 语句

ITERATE 语句也是用来跳出循环的语句，但是 ITERATE 语句是跳出本次循环，然后直接进入下一次循环。ITERATE 语句的语法形式如下：

```sql
ITERATE label
```

其中，参数 label 表示循环的标志。

**示例**

```sql
add_num:LOOP
    SET @count1=@count1+1;
    IF @count1=100 THEN
        LEAVE add_num;
    ELSEIF MOD(@count1,3)=0 THEN
        ITERATE add_num;
END LOOP add_num;
```

### REPEAT 语句

REPEAT 语句是有条件控制的循环语句。当满足特定条件时，就会跳出循环语句。REPEAT 语句的基本语法形式如下：

```sql
[begin_label:]REPEAT 
    statement_list
    UNTIL search_condition
END REPEAT [end_label]
```

其中，参数 statement_list 表示循环的执行语句；参数 search_condition 表示结束循环的条件，满足该条件时循环结束。

**示例**

```sql
REPEAT
    SET @count1=@count1+1;
    UNTIL @count1=100
END REPEAT;
```

### WHILE 语句

WHILE 语句也是有条件控制的循环语句，但 WHILE 语句和 REPEAT 语句是不一样的。WHILE 语句是当满足条件时，执行循环内的语句。WHILE 语句的基本语法形式如下：

```sql
[begin_label:]WHILE search_condition DO
    statement_list
END WHILE [end_label]
```

其中，参数 statement_condition 表示循环执行的条件，满足该条件时循环执行；参数 statement_list 表示循环的执行语句。

**示例**

```sql
WHILE @count1<100 DO
    SET @count1=@count1+1;
END WHILE;
```